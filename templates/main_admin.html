<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Administración principal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card-bg:#fff; --muted:#f6f7fb; --border:#e8e9ef; }
    body { font-family: system-ui, Arial; margin:0; background: var(--muted); color:#111; }
    .wrap { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom: 12px; }
    .btn {
      display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #ccc;
      background:#fff; color:#111; text-decoration:none; cursor:pointer;
    }
    .card {
      background: var(--card-bg); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.08);
      padding: 18px 20px; margin-bottom: 18px; border: 1px solid var(--border);
    }
    h1 { margin: 6px 0 12px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select {
      width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin-top:4px; box-sizing:border-box;
      background:#fff;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > div { flex:1 1 170px; min-width: 170px; }
    .actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    .hint { color:#555; font-size:12px; margin-top:4px; }
    .section-title { font-weight:700; margin: 12px 0 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="{{ url_for('index') }}">← Volver al mapa</a>
      <a class="btn" href="{{ url_for('admin_panel') }}">Panel admin (usuarios)</a>
      <a class="btn" href="{{ url_for('logout') }}">Cerrar sesión</a>
      <div style="margin-left:auto; font-size:13px;">Sesión: <strong>{{ user }}</strong></div>
    </div>

    <h1>Administración principal</h1>

    <!-- Configuración de mapa -->
    <div class="card">
      <h2>Configuración de vista del mapa (inicio)</h2>
      <div class="row">
        <div>
          <label>Longitud</label>
          <input id="lon" type="number" step="0.000001" value="{{ settings.center_lon }}">
        </div>
        <div>
          <label>Latitud</label>
          <input id="lat" type="number" step="0.000001" value="{{ settings.center_lat }}">
        </div>
        <div>
          <label>Zoom</label>
          <input id="zoom" type="number" step="0.1" value="{{ settings.zoom }}">
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="guardarSettings()">Guardar</button>
      </div>
      <div class="hint">Estos valores se aplican como centro y zoom por defecto cuando cualquier usuario abre la aplicación.</div>
    </div>

    <!-- Descargas -->
    <div class="card">
      <h2>Descargar reportes</h2>

      <div class="section-title">Por día</div>
      <div class="row">
        <div><input type="date" id="day"></div>
        <div class="actions"><button class="btn" onclick="descargarDia()">Descargar día</button></div>
      </div>

      <div class="section-title">Por mes</div>
      <div class="row">
        <div>
          <!-- input month no es soportado en todos los navegadores; fallback con text -->
          <label style="font-weight:400;margin-top:0;">Formato: YYYY-MM</label>
          <input type="text" id="month" placeholder="2025-09" pattern="\\d{4}-\\d{2}">
        </div>
        <div class="actions"><button class="btn" onclick="descargarMes()">Descargar mes</button></div>
      </div>

      <div class="section-title">Por año</div>
      <div class="row">
        <div><input type="number" id="year" placeholder="2025" min="2000" max="2100" step="1"></div>
        <div class="actions"><button class="btn" onclick="descargarAnio()">Descargar año</button></div>
      </div>

      <div class="section-title">Por rango</div>
      <div class="row">
        <div><input type="date" id="rStart"></div>
        <div><input type="date" id="rEnd"></div>
        <div class="actions"><button class="btn" onclick="descargarRango()">Descargar rango</button></div>
      </div>
    </div>
  </div>

  <script>
    async function guardarSettings() {
      const body = {
        center_lon: parseFloat(document.getElementById('lon').value),
        center_lat: parseFloat(document.getElementById('lat').value),
        zoom: parseFloat(document.getElementById('zoom').value)
      };
      const r = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (r.ok) alert('Configuración guardada');
      else alert('No se pudo guardar');
    }

    function descargarDia() {
      const d = document.getElementById('day').value;
      if (!d) return alert('Selecciona una fecha (día)');
      location.href = '/exportar/excel?date=' + d;
    }
    function descargarMes() {
      const m = document.getElementById('month').value;
      if (!/^\d{4}-\d{2}$/.test(m)) return alert('Mes inválido. Usa YYYY-MM');
      location.href = '/exportar/excel?month=' + m;
    }
    function descargarAnio() {
      const y = document.getElementById('year').value;
      if (!/^\d{4}$/.test(y)) return alert('Año inválido. Usa YYYY');
      location.href = '/exportar/excel?year=' + y;
    }
    function descargarRango() {
      const a = document.getElementById('rStart').value;
      const b = document.getElementById('rEnd').value;
      if (!a && !b) return alert('Selecciona al menos una fecha');
      const qs = new URLSearchParams();
      if (a) qs.set('start', a);
      if (b) qs.set('end', b);
      location.href = '/exportar/excel?' + qs.toString();
    }
  </script>
</body>
</html>
